name: Deploy (prod)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      reason:
        description: "Why deploy? (optional)"
        required: false
        default: "manual"

concurrency:
  group: knowra-prod
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: SSH deploy
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Prepare SSH
        shell: bash
        run: |
          set -euo pipefail
          SSH_PORT="${SSH_PORT:-22}"

          if [[ -z "${SSH_HOST:-}" ]]; then
            echo "Missing SSH_HOST secret" >&2
            exit 1
          fi
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          if [[ -z "${SSH_PRIVATE_KEY:-}" ]]; then
            echo "Missing SSH_PRIVATE_KEY secret" >&2
            exit 1
          fi

          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          touch ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

          if [[ -n "${SSH_HOST_KEY:-}" ]]; then
            echo "$SSH_HOST_KEY" >> ~/.ssh/known_hosts
          else
            echo "SSH_HOST_KEY not set; using ssh-keyscan" >&2
            ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts
          fi
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST_KEY: ${{ secrets.SSH_HOST_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}

      - name: Deploy on server
        shell: bash
        run: |
          set -euo pipefail
          SSH_PORT="${SSH_PORT:-22}"

          if [[ -z "${SSH_HOST:-}" || -z "${SSH_USER:-}" || -z "${DEPLOY_PATH:-}" ]]; then
            echo "Missing one of required secrets: SSH_HOST / SSH_USER / DEPLOY_PATH" >&2
            exit 1
          fi

          echo "Deploy reason: ${REASON}"
          echo "Target: ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}"

          ssh -p "${SSH_PORT}" -o BatchMode=yes "${SSH_USER}@${SSH_HOST}" \
            "cd '${DEPLOY_PATH}' && chmod +x ./deploy.sh && ./deploy.sh"
        env:
          REASON: ${{ github.event.inputs.reason || 'push' }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
