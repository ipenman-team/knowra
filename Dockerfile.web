FROM node:20-slim

WORKDIR /app

ARG GIT_COMMIT=unknown
ARG COREPACK_NPM_REGISTRY=https://registry.npmjs.org
ARG NPM_REGISTRY=https://registry.npmjs.org

ENV CONTEXTA_GIT_COMMIT=${GIT_COMMIT}

LABEL org.opencontainers.image.revision=${GIT_COMMIT}

ENV COREPACK_NPM_REGISTRY=${COREPACK_NPM_REGISTRY}
ENV npm_config_registry=${NPM_REGISTRY}

RUN corepack enable

COPY . .

RUN pnpm -w --filter @contexta/web... install --frozen-lockfile --prod=false --config.node-linker=isolated
RUN pnpm --dir packages/shared build
RUN pnpm --dir packages/utils build

ARG NEXT_PUBLIC_API_BASE_URL=/api
ENV NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}

ARG NEXT_PUBLIC_CONTEXTA_AI_BASE_URL=/contexta-ai
ENV NEXT_PUBLIC_CONTEXTA_AI_BASE_URL=${NEXT_PUBLIC_CONTEXTA_AI_BASE_URL}
ENV NODE_ENV=production
ENV PORT=3000

RUN pnpm --dir apps/web build

WORKDIR /app/apps/web

EXPOSE 3000

CMD ["pnpm", "start"]
